name: Push demo branch to Hugging Face

on:
  workflow_call:
    inputs:
      ref:
        required: false
        default: demo
        type: string
    secrets:
      HF_TOKEN:
        required: true

jobs:
  push-hf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub

    - name: Push to Hugging Face
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_REPO_TYPE: spaces
        HF_REPO_ID: chenzihong/GraphGen
      run: |
        set -x          # 打开调试，让每一步路径都打印出来
        git config --global credential.helper store
        echo "https://user:${HF_TOKEN}@huggingface.co" > ~/.git-credentials

        [[ -d hf-repo ]] && rm -rf hf-repo
        git clone https://huggingface.co/${HF_REPO_TYPE}/${HF_REPO_ID} hf-repo

        # 打印当前目录和 hf-repo 目录
        pwd
        ls -la
        ls -la hf-repo

        # 关键：确保“源”是当前仓库，“目标”是 hf-repo
        rsync -a --delete --exclude='.git' ./ hf-repo/

        cd hf-repo
        git add .
        git diff-index --quiet HEAD || \
          (git commit -m "Auto-sync from ${{ inputs.ref }} at $(date -u)" && git push)